<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출결 관리 시스템</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            background-color: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .header-right {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        
        .header h1 {
            margin: 0 0 4px 0;
            font-size: 20px;
        }
        
        .date-nav-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin: 4px 0;
        }
        
        .date-display {
            font-size: 14px;
            color: #007bff;
            margin: 0;
            min-width: 160px;
            text-align: center;
        }
        
        .date-nav-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }
        
        .date-nav-btn:hover {
            background-color: #0056b3;
        }
        
        .today-btn {
            margin-top: 5px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid;
        }
        
        .stat-item.present { border-left-color: #28a745; }
        .stat-item.absent { border-left-color: #dc3545; }
        .stat-item.late { border-left-color: #ffc107; }
        .stat-item.early { border-left-color: #17a2b8; }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 1fr 370px;
            gap: 15px;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        
        .controls {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        
        .controls h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
        }
        
        .control-button {
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .export-btn { background-color: #28a745; color: white; }
        .export-btn:hover { background-color: #218838; }
        
        .history-btn { background-color: #007bff; color: white; }
        .history-btn:hover { background-color: #0056b3; }
        
        .reset-btn { background-color: #6c757d; color: white; }
        .reset-btn:hover { background-color: #5a6268; }
        
        .clear-all-btn { background-color: #dc3545; color: white; }
        .clear-all-btn:hover { background-color: #c82333; }
        
        .calendar-section {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .day-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background-color: #0056b3;
        }
        
        .calendar-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-day-header {
            background-color: #f8f9fa;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
        }
        
        .calendar-day {
            border: 1px solid #dee2e6;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 8px 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 65px;
            font-size: 13px;
        }
        
        .calendar-day:hover {
            background-color: #f8f9fa;
        }
        
        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        .calendar-day.today {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }
        
        .calendar-day.selected {
            background-color: #007bff;
            color: white;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 16px;
        }
        
        .day-stats {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            font-size: 10px;
            width: 100%;
        }
        
        .stat-badge {
            display: block;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            font-size: 9px;
            text-align: center;
            margin: 1px 0;
            max-width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: help;
        }
        
        .stat-badge.absent { background-color: #dc3545; }
        .stat-badge.late { background-color: #ffc107; color: #212529; }
        .stat-badge.early { background-color: #17a2b8; }
        
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        
        .student-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #f8f9fa;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .student-card.absent {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        
        .student-card.late {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        
        .student-card.early-leave {
            background-color: #d1ecf1;
            border-color: #17a2b8;
        }
        
        .student-card.absent .student-number,
        .student-card.late .student-number,
        .student-card.early-leave .student-number {
            color: #333;
        }
        
        .student-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            min-height: 20px;
        }
        
        .student-number {
            font-size: 16px;
            font-weight: bold;
            color: #999;
            transition: color 0.3s ease;
        }
        
        .student-status {
            font-size: 10px;
            color: #666;
            min-width: 30px;
            text-align: left;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
        }
        
        .status-btn {
            padding: 4px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .btn-absent {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-absent:hover {
            background-color: #c82333;
        }
        
        .btn-late {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-late:hover {
            background-color: #e0a800;
        }
        
        .btn-early {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-early:hover {
            background-color: #138496;
        }
        
        .btn-clear {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-clear:hover {
            background-color: #5a6268;
        }
        
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .period-modal {
            max-width: 400px;
            text-align: center;
        }
        
        .period-modal h3 {
            margin: 0 0 20px 0;
            font-size: 18px;
            color: #333;
        }
        
        .period-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .period-btn {
            padding: 15px 10px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background-color: white;
            color: #007bff;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .period-btn:hover {
            background-color: #007bff;
            color: white;
        }
        
        .period-btn.cancel-btn {
            grid-column: span 4;
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .period-btn.cancel-btn:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            margin: 0;
        }
        
        /* 프린트 전용 스타일 */
        @media print {
            body * {
                visibility: hidden;
            }
            
            #historyModal, #historyModal * {
                visibility: visible;
            }
            
            #historyModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: white !important;
                margin: 0;
                padding: 20px;
                box-sizing: border-box;
            }
            
            .modal-content {
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            .close, .control-button {
                display: none !important;
            }
            
            .modal-header {
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            
            .modal-header h2 {
                color: #333 !important;
                font-size: 24px !important;
            }
        }
        
        /* 반응형 디자인 */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            .student-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-right {
                justify-content: center;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .student-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 8px;
            }
            
            .calendar-day {
                min-height: 50px;
                font-size: 12px;
            }
            
            .day-number {
                font-size: 14px;
            }
            
            .header-right {
                flex-direction: column;
                gap: 8px;
            }
            
            .control-button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>📋 출결 관리 시스템</h1>
            <div class="date-nav-container">
                <button class="date-nav-btn" onclick="changeWorkingDate(-1)">◀</button>
                <div class="date-display" id="workingDate"></div>
                <button class="date-nav-btn" onclick="changeWorkingDate(1)">▶</button>
                <button class="date-nav-btn today-btn" onclick="goToWorkingToday()">오늘로</button>
            </div>
        </div>
        <div class="header-right">
            <button class="control-button history-btn" onclick="showHistory()">📚 누적 기록</button>
            <button class="control-button export-btn" onclick="exportTodayToCSV()">📄 오늘 기록</button>
            <button class="control-button export-btn" onclick="exportAllToCSV()">📊 전체 내보내기</button>
            <button class="control-button reset-btn" onclick="resetToday()">🔄 오늘 초기화</button>
            <button class="control-button clear-all-btn" onclick="resetAllData()">🗑️ 모두 초기화</button>
        </div>
    </div>
    
    <div class="main-container">
        <div class="left-panel">
            <div class="student-grid" id="studentGrid">
                <!-- 학생 카드들이 여기에 생성됩니다 -->
            </div>
        </div>
        
        <div class="right-panel">
            <div class="calendar-section">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="changeMonth(-1)">◀ 이전</button>
                        <h2 class="calendar-title" id="calendarTitle"></h2>
                        <button class="nav-btn" onclick="changeMonth(1)">다음 ▶</button>
                    </div>
                    <button class="nav-btn" onclick="goToToday()">오늘</button>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                <!-- 달력이 여기에 생성됩니다 -->
            </div>
        </div>
    </div>

    <!-- 누적 기록 모달 -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistory()">&times;</span>
            <div class="modal-header">
                <h2>📚 누적 출결 기록</h2>
                <button class="control-button export-btn" onclick="printHistory()">📄 프린트</button>
            </div>
            <div id="historyContent">
                <!-- 누적 기록이 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <!-- 교시 선택 모달 -->
    <div id="periodModal" class="modal">
        <div class="modal-content period-modal">
            <h3 id="periodModalTitle">몇 교시인가요?</h3>
            <div class="period-grid">
                <button class="period-btn" onclick="selectPeriod('조례')">조례</button>
                <button class="period-btn" onclick="selectPeriod(1)">1교시</button>
                <button class="period-btn" onclick="selectPeriod(2)">2교시</button>
                <button class="period-btn" onclick="selectPeriod(3)">3교시</button>
                <button class="period-btn" onclick="selectPeriod(4)">4교시</button>
                <button class="period-btn" onclick="selectPeriod(5)">5교시</button>
                <button class="period-btn" onclick="selectPeriod(6)">6교시</button>
                <button class="period-btn" onclick="selectPeriod(7)">7교시</button>
                <button class="period-btn cancel-btn" onclick="closePeriodModal()">취소</button>
            </div>
        </div>
    </div>

    <script>
        let todayAttendance = {};
        let allRecords = {}; // 날짜별 누적 기록
        let currentDate = new Date();
        let selectedDate = new Date();
        let workingDate = new Date(); // 현재 작업 중인 날짜
        let pendingStudent = null; // 교시 선택 대기 중인 학생
        let pendingStatus = null; // 교시 선택 대기 중인 상태
        
        // 작업 날짜 표시
        function displayWorkingDate() {
            const dateString = workingDate.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('workingDate').textContent = dateString;
        }
        
        // 달력 생성
        function createCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarTitle = document.getElementById('calendarTitle');
            
            // 월/년 제목 설정
            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', 
                               '7월', '8월', '9월', '10월', '11월', '12월'];
            calendarTitle.textContent = `${currentDate.getFullYear()}년 ${monthNames[currentDate.getMonth()]}`;
            
            // 달력 그리드 초기화
            calendarGrid.innerHTML = '';
            
            // 요일 헤더 추가 (평일만)
            const dayHeaders = ['월', '화', '수', '목', '금'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
            
            // 달의 첫째 날과 마지막 날 계산
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            // 해당 월의 모든 날짜를 수집하고 평일만 필터링
            const weekdays = [];
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dayOfWeek = date.getDay(); // 0: 일요일, 1: 월요일, ..., 6: 토요일
                
                // 평일만 포함 (월~금: 1~5)
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    weekdays.push(date);
                }
            }
            
            // 이전 달의 평일들도 필요하면 추가 (첫 주가 비어있을 경우)
            const firstWeekday = firstDay.getDay();
            if (firstWeekday > 1) { // 월요일(1)이 아닌 경우
                const prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0);
                for (let i = firstWeekday - 1; i >= 1; i--) {
                    const date = new Date(prevMonth.getFullYear(), prevMonth.getMonth(), prevMonth.getDate() - (firstWeekday - 1 - i));
                    if (date.getDay() >= 1 && date.getDay() <= 5) {
                        weekdays.unshift(date);
                    }
                }
            }
            
            // 다음 달의 평일들도 필요하면 추가 (마지막 주가 비어있을 경우)
            const totalDays = weekdays.length;
            const weeksNeeded = Math.ceil(totalDays / 5);
            const totalCells = weeksNeeded * 5;
            
            if (totalDays < totalCells) {
                const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                let day = 1;
                while (weekdays.length < totalCells) {
                    const date = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), day);
                    if (date.getDay() >= 1 && date.getDay() <= 5) {
                        weekdays.push(date);
                    }
                    day++;
                }
            }
            
            // 평일들만 달력에 표시
            weekdays.forEach(date => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // 다른 달인지 확인
                if (date.getMonth() !== currentDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
                
                // 오늘인지 확인
                const today = new Date();
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // 선택된 날짜인지 확인
                if (date.toDateString() === selectedDate.toDateString()) {
                    dayElement.classList.add('selected');
                }
                
                // 날짜 클릭 이벤트
                dayElement.onclick = () => selectDate(date);
                
                // 날짜 번호
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);
                
                // 해당 날짜의 출결 학생 번호 표시
                const dateKey = date.toLocaleDateString('ko-KR');
                if (allRecords[dateKey]) {
                    const dayStats = document.createElement('div');
                    dayStats.className = 'day-stats';
                    
                    const studentsByStatus = getStudentsByStatus(allRecords[dateKey]);
                    
                    // 결석 학생 번호들
                    if (studentsByStatus.absent.length > 0) {
                        const badge = document.createElement('span');
                        badge.className = 'stat-badge absent';
                        const sortedNumbers = studentsByStatus.absent.sort((a, b) => a - b);
                        const displayText = getDisplayText(sortedNumbers);
                        badge.textContent = displayText;
                        badge.title = `결석: ${sortedNumbers.join(', ')}번`;
                        dayStats.appendChild(badge);
                    }
                    
                    // 지각 학생 번호들
                    if (studentsByStatus.late.length > 0) {
                        const badge = document.createElement('span');
                        badge.className = 'stat-badge late';
                        const sortedNumbers = studentsByStatus.late.sort((a, b) => a - b);
                        const displayText = getDisplayText(sortedNumbers);
                        badge.textContent = displayText;
                        badge.title = `지각: ${sortedNumbers.join(', ')}번`;
                        dayStats.appendChild(badge);
                    }
                    
                    // 조퇴 학생 번호들
                    if (studentsByStatus['early-leave'].length > 0) {
                        const badge = document.createElement('span');
                        badge.className = 'stat-badge early';
                        const sortedNumbers = studentsByStatus['early-leave'].sort((a, b) => a - b);
                        const displayText = getDisplayText(sortedNumbers);
                        badge.textContent = displayText;
                        badge.title = `조퇴: ${sortedNumbers.join(', ')}번`;
                        dayStats.appendChild(badge);
                    }
                    
                    dayElement.appendChild(dayStats);
                }
                
                calendarGrid.appendChild(dayElement);
            });
        }
        
        // 날짜별 통계 계산
        function getDateStats(dayRecords) {
            const stats = { absent: 0, late: 0, 'early-leave': 0 };
            
            Object.values(dayRecords).forEach(record => {
                if (stats.hasOwnProperty(record.status)) {
                    stats[record.status]++;
                }
            });
            
            return stats;
        }
        
        // 날짜별 학생 번호 분류
        function getStudentsByStatus(dayRecords) {
            const studentsByStatus = { 
                absent: [], 
                late: [], 
                'early-leave': [] 
            };
            
            Object.keys(dayRecords).forEach(studentNumber => {
                const record = dayRecords[studentNumber];
                if (studentsByStatus.hasOwnProperty(record.status)) {
                    studentsByStatus[record.status].push(parseInt(studentNumber));
                }
            });
            
            return studentsByStatus;
        }
        
        // 학생 번호 표시 텍스트 생성 (너무 길면 줄임)
        function getDisplayText(numbers) {
            const text = numbers.join(',');
            
            // 12글자 이하면 그대로 표시
            if (text.length <= 12) {
                return text;
            }
            
            // 너무 길면 앞의 몇 개만 표시하고 +개수 추가
            let displayText = '';
            let charCount = 0;
            let displayCount = 0;
            
            for (let i = 0; i < numbers.length; i++) {
                const numberText = numbers[i].toString();
                const separator = i > 0 ? ',' : '';
                
                if (charCount + separator.length + numberText.length <= 8) {
                    displayText += separator + numberText;
                    charCount += separator.length + numberText.length;
                    displayCount++;
                } else {
                    break;
                }
            }
            
            const remaining = numbers.length - displayCount;
            if (remaining > 0) {
                displayText += `+${remaining}`;
            }
            
            return displayText;
        }
        
        // 달 변경
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            createCalendar();
        }
        
        // 작업 날짜 변경 (평일만)
        function changeWorkingDate(direction) {
            let newDate = new Date(workingDate);
            
            do {
                newDate.setDate(newDate.getDate() + direction);
            } while (newDate.getDay() === 0 || newDate.getDay() === 6); // 주말 건너뛰기
            
            workingDate = newDate;
            selectedDate = new Date(workingDate); // 선택된 날짜도 함께 변경
            
            // 작업 날짜가 현재 표시 중인 달과 다르면 달력 월 변경
            if (workingDate.getMonth() !== currentDate.getMonth() || 
                workingDate.getFullYear() !== currentDate.getFullYear()) {
                currentDate = new Date(workingDate);
            }
            
            displayWorkingDate();
            loadWorkingDateData();
            createCalendar();
        }
        
        // 작업 날짜를 오늘로 변경
        function goToWorkingToday() {
            const today = new Date();
            // 오늘이 주말이면 가장 가까운 평일로
            if (today.getDay() === 0) { // 일요일
                today.setDate(today.getDate() + 1); // 월요일로
            } else if (today.getDay() === 6) { // 토요일
                today.setDate(today.getDate() + 2); // 월요일로
            }
            
            workingDate = today;
            selectedDate = new Date(workingDate);
            currentDate = new Date(workingDate);
            
            displayWorkingDate();
            loadWorkingDateData();
            createCalendar();
        }
        
        // 오늘로 이동
        function goToToday() {
            currentDate = new Date();
            selectedDate = new Date();
            createCalendar();
        }
        
        // 날짜 선택
        function selectDate(date) {
            selectedDate = new Date(date);
            
            // 작업 날짜도 함께 변경 (평일만)
            if (date.getDay() >= 1 && date.getDay() <= 5) { // 평일인 경우만
                workingDate = new Date(date);
                
                // 화면 업데이트
                displayWorkingDate();
                loadWorkingDateData();
            }
            
            createCalendar();
        }
        
        // 학생 카드들 생성
        function createStudentCards() {
            const studentGrid = document.getElementById('studentGrid');
            
            for (let i = 1; i <= 35; i++) {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.id = `student-${i}`;
                
                card.innerHTML = `
                    <div class="student-header">
                        <div class="student-status" id="status-${i}"></div>
                        <div class="student-number">${i}번</div>
                    </div>
                    <div class="button-group">
                        <button class="status-btn btn-absent" onclick="setAttendance(${i}, 'absent')">결석</button>
                        <button class="status-btn btn-late" onclick="showPeriodModal(${i}, 'late')">지각</button>
                        <button class="status-btn btn-early" onclick="showPeriodModal(${i}, 'early-leave')">조퇴</button>
                        <button class="status-btn btn-clear" onclick="clearAttendance(${i})">취소</button>
                    </div>
                `;
                
                studentGrid.appendChild(card);
            }
        }
        
        // 작업 날짜 데이터 로드
        function loadWorkingDateData() {
            const workingDateKey = workingDate.toLocaleDateString('ko-KR');
            
            // 로컬 스토리지에서 해당 날짜 데이터 불러오기
            const savedData = localStorage.getItem(`attendance_${workingDateKey}`);
            let workingData = {};
            
            if (savedData) {
                workingData = JSON.parse(savedData);
                // allRecords에도 동기화
                allRecords[workingDateKey] = { ...workingData };
            } else {
                // allRecords에서 찾기
                workingData = allRecords[workingDateKey] || {};
            }
            
            // 모든 학생을 정상 상태로 초기화
            for (let i = 1; i <= 35; i++) {
                const card = document.getElementById(`student-${i}`);
                const statusDiv = document.getElementById(`status-${i}`);
                
                if (card && statusDiv) {
                    card.classList.remove('absent', 'late', 'early-leave');
                    statusDiv.textContent = '';
                }
            }
            
            // 해당 날짜의 출결 데이터 복원
            todayAttendance = { ...workingData };
            
            Object.keys(workingData).forEach(studentNumber => {
                const record = workingData[studentNumber];
                const card = document.getElementById(`student-${studentNumber}`);
                const statusDiv = document.getElementById(`status-${studentNumber}`);
                
                if (card && statusDiv) {
                    card.classList.add(record.status);
                    let displayText = getStatusKorean(record.status);
                    if (record.period && (record.status === 'late' || record.status === 'early-leave')) {
                        displayText += ` (${record.period}교시)`;
                    }
                    statusDiv.textContent = displayText;
                }
            });
            
            updateTodayStats();
        }
        
        // 교시 선택 모달 표시
        function showPeriodModal(studentNumber, status) {
            pendingStudent = studentNumber;
            pendingStatus = status;
            
            const modal = document.getElementById('periodModal');
            const title = document.getElementById('periodModalTitle');
            
            const statusText = status === 'late' ? '지각' : '조퇴';
            title.textContent = `${studentNumber}번 학생 ${statusText} - 몇 교시인가요?`;
            
            modal.style.display = 'block';
        }
        
        // 교시 선택
        function selectPeriod(period) {
            if (pendingStudent && pendingStatus) {
                setAttendanceWithPeriod(pendingStudent, pendingStatus, period);
                closePeriodModal();
            }
        }
        
        // 교시 모달 닫기
        function closePeriodModal() {
            document.getElementById('periodModal').style.display = 'none';
            pendingStudent = null;
            pendingStatus = null;
        }
        
        // 교시 정보가 포함된 출결 상태 설정
        function setAttendanceWithPeriod(studentNumber, status, period = null) {
            const card = document.getElementById(`student-${studentNumber}`);
            const statusDiv = document.getElementById(`status-${studentNumber}`);
            const currentTime = new Date();
            const workingDateKey = workingDate.toLocaleDateString('ko-KR');
            
            // 이전 상태 제거
            card.classList.remove('absent', 'late', 'early-leave');
            
            // 새 상태 설정
            card.classList.add(status);
            
            const statusText = {
                'absent': '결석',
                'late': '지각',
                'early-leave': '조퇴'
            };
            
            const timeString = currentTime.toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // 교시 정보 포함된 텍스트 생성
            let displayText = statusText[status];
            if (period && (status === 'late' || status === 'early-leave')) {
                displayText += ` (${period}교시)`;
            }
            
            statusDiv.textContent = displayText;
            
            // 작업 날짜 출결 기록에 추가
            if (!todayAttendance[studentNumber] || todayAttendance[studentNumber].status !== status || todayAttendance[studentNumber].period !== period) {
                todayAttendance[studentNumber] = {
                    status: status,
                    time: timeString,
                    timestamp: currentTime.toISOString(),
                    date: workingDateKey,
                    period: period // 교시 정보 추가
                };
            }
            
            // 먼저 allRecords 업데이트
            allRecords[workingDateKey] = { ...todayAttendance };
            
            updateTodayStats();
            saveWorkingDateData();
            
            
            // 달력 새로고침 (작업 날짜에 배지 표시) - 약간의 지연으로 확실한 업데이트
            setTimeout(() => {
                createCalendar();
            }, 10);
            
            const periodText = period ? ` (${period}교시)` : '';
            showMessage(`${studentNumber}번 학생이 ${statusText[status]}${periodText}으로 처리되었습니다.`);
        }
        
        // 출결 상태 설정 (결석용 - 교시 없음)
        function setAttendance(studentNumber, status) {
            // 결석은 교시 정보 없이 바로 처리
            setAttendanceWithPeriod(studentNumber, status, null);
        }
        
        // 출결 상태 취소
        function clearAttendance(studentNumber) {
            const card = document.getElementById(`student-${studentNumber}`);
            const statusDiv = document.getElementById(`status-${studentNumber}`);
            
            // 상태 제거
            card.classList.remove('absent', 'late', 'early-leave');
            statusDiv.textContent = '';
            
            // 기록에서 제거
            delete todayAttendance[studentNumber];
            
            // 먼저 allRecords 업데이트
            const workingDateKey = workingDate.toLocaleDateString('ko-KR');
            allRecords[workingDateKey] = { ...todayAttendance };
            
            updateTodayStats();
            saveWorkingDateData();
            
            
            // 달력 새로고침 - 약간의 지연으로 확실한 업데이트
            setTimeout(() => {
                createCalendar();
            }, 10);
            
            showMessage(`${studentNumber}번 학생의 출결이 취소되었습니다.`);
        }
        
        // 오늘 통계 업데이트 (통계 섹션이 없으므로 빈 함수)
        function updateTodayStats() {
            // 통계 표시 섹션이 제거되었으므로 실제 동작은 하지 않음
            // 함수 호출 오류를 방지하기 위해 빈 함수로 유지
        }
        
        
        
        // 상태 한글 변환
        function getStatusKorean(status) {
            const statusMap = {
                'absent': '결석',
                'late': '지각',
                'early-leave': '조퇴'
            };
            return statusMap[status] || status;
        }
        
        
        // 메시지 표시 (간단한 콘솔 로그)
        function showMessage(message) {
            console.log(message);
        }
        
        // 오늘 초기화
        function resetToday() {
            if (confirm('오늘의 출결을 모두 초기화하시겠습니까?')) {
                todayAttendance = {};
                
                // 모든 학생을 출석으로 초기화
                for (let i = 1; i <= 35; i++) {
                    const card = document.getElementById(`student-${i}`);
                    const statusDiv = document.getElementById(`status-${i}`);
                    
                    card.classList.remove('absent', 'late', 'early-leave');
                    card.classList.add('present');
                    statusDiv.textContent = '출석';
                }
                
                updateTodayStats();
                saveToLocalStorage();
                
                showMessage('오늘 출결이 초기화되었습니다.');
            }
        }
        
        // 오늘 기록 CSV 내보내기
        function exportTodayToCSV() {
            const records = Object.keys(todayAttendance).map(studentNumber => {
                const record = todayAttendance[studentNumber];
                return `${record.date},${studentNumber},${getStatusKorean(record.status)},${record.time}`;
            });
            
            if (records.length === 0) {
                alert('내보낼 기록이 없습니다.');
                return;
            }
            
            const workingDateString = workingDate.toLocaleDateString('ko-KR', {
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            if (confirm(`${workingDateString}의 출결 기록을 CSV 파일로 다운로드하시겠습니까?\n\n총 ${records.length}건의 기록이 있습니다.`)) {
                const today = new Date().toLocaleDateString('ko-KR');
                const csvContent = 'data:text/csv;charset=utf-8,' 
                    + '날짜,학생번호,상태,시간\n'
                    + records.join('\n');
                
                downloadCSV(csvContent, `출결기록_${today}.csv`);
            }
        }
        
        // 전체 기록 CSV 내보내기
        function exportAllToCSV() {
            let allCsvRecords = [];
            
            Object.keys(allRecords).forEach(date => {
                Object.keys(allRecords[date]).forEach(studentNumber => {
                    const record = allRecords[date][studentNumber];
                    allCsvRecords.push(`${date},${studentNumber},${getStatusKorean(record.status)},${record.time}`);
                });
            });
            
            if (allCsvRecords.length === 0) {
                alert('내보낼 누적 기록이 없습니다.');
                return;
            }
            
            const totalDays = Object.keys(allRecords).length;
            
            if (confirm(`전체 출결 기록을 CSV 파일로 다운로드하시겠습니까?\n\n총 ${totalDays}일간 ${allCsvRecords.length}건의 기록이 있습니다.`)) {
                const csvContent = 'data:text/csv;charset=utf-8,' 
                    + '날짜,학생번호,상태,시간\n'
                    + allCsvRecords.join('\n');
                
                const today = new Date().toLocaleDateString('ko-KR');
                downloadCSV(csvContent, `전체출결기록_${today}.csv`);
            }
        }
        
        // CSV 다운로드 헬퍼 함수
        function downloadCSV(csvContent, filename) {
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 누적 기록 보기
        function showHistory() {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            
            if (Object.keys(allRecords).length === 0) {
                content.innerHTML = '<p style="text-align: center; color: #666;">아직 누적 기록이 없습니다.</p>';
            } else {
                let historyHTML = '';
                
                Object.keys(allRecords).sort().reverse().forEach(date => {
                    const dayRecords = allRecords[date];
                    const recordCount = Object.keys(dayRecords).length;
                    
                    historyHTML += `
                        <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <h4 style="cursor: pointer; color: #007bff; text-decoration: underline;" onclick="goToDate('${date}')" title="클릭하여 ${date}로 이동">${date} (${recordCount}건)</h4>
                            <div style="display: grid; gap: 8px;">
                    `;
                    
                    Object.keys(dayRecords).forEach(studentNumber => {
                        const record = dayRecords[studentNumber];
                        let statusText = getStatusKorean(record.status);
                        if (record.period && (record.status === 'late' || record.status === 'early-leave')) {
                            statusText += ` (${record.period}교시)`;
                        }
                        historyHTML += `
                            <div style="display: flex; justify-content: space-between; padding: 8px; background-color: white; border-radius: 4px;">
                                <span><strong>${studentNumber}번</strong> - ${statusText}</span>
                                <span>${record.time}</span>
                            </div>
                        `;
                    });
                    
                    historyHTML += '</div></div>';
                });
                
                content.innerHTML = historyHTML;
            }
            
            modal.style.display = 'block';
        }
        
        // 누적 기록 모달 닫기
        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        // 누적 기록 프린트
        function printHistory() {
            if (Object.keys(allRecords).length === 0) {
                alert('프린트할 누적 기록이 없습니다.');
                return;
            }
            
            const totalRecords = Object.keys(allRecords).reduce((total, date) => {
                return total + Object.keys(allRecords[date]).length;
            }, 0);
            
            if (confirm(`누적 출결 기록을 프린트하시겠습니까?\n\n총 ${Object.keys(allRecords).length}일간 ${totalRecords}건의 기록이 있습니다.`)) {
                window.print();
            }
        }
        
        // 특정 날짜로 이동 (누적 기록에서 호출)
        function goToDate(dateString) {
            // 한국 날짜 문자열을 Date 객체로 변환
            const dateParts = dateString.split('.');
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1; // JavaScript 월은 0부터 시작
            const day = parseInt(dateParts[2]);
            
            const targetDate = new Date(year, month, day);
            
            // 주말인지 확인하고 평일로 조정
            if (targetDate.getDay() === 0) { // 일요일
                targetDate.setDate(targetDate.getDate() + 1); // 월요일로
            } else if (targetDate.getDay() === 6) { // 토요일
                targetDate.setDate(targetDate.getDate() + 2); // 월요일로
            }
            
            // 작업 날짜와 선택된 날짜 변경
            workingDate = new Date(targetDate);
            selectedDate = new Date(targetDate);
            currentDate = new Date(targetDate);
            
            // 모달 닫기
            closeHistory();
            
            // 화면 업데이트
            displayWorkingDate();
            loadWorkingDateData();
            createCalendar();
        }
        
        // 작업 날짜 데이터 저장
        function saveWorkingDateData() {
            const workingDateKey = workingDate.toLocaleDateString('ko-KR');
            
            // 작업 날짜 기록 저장
            localStorage.setItem(`attendance_${workingDateKey}`, JSON.stringify(todayAttendance));
            
            // 누적 기록에 추가
            allRecords[workingDateKey] = { ...todayAttendance };
            localStorage.setItem('attendance_all', JSON.stringify(allRecords));
        }
        
        // 로컬 스토리지에 저장 (하위 호환용)
        function saveToLocalStorage() {
            saveWorkingDateData();
        }
        
        // 로컬 스토리지에서 불러오기
        function loadFromLocalStorage() {
            // 누적 기록 불러오기
            const allData = localStorage.getItem('attendance_all');
            if (allData) {
                allRecords = JSON.parse(allData);
            }
        }
        
        // 작업 날짜 초기화
        function resetToday() {
            const workingDateString = workingDate.toLocaleDateString('ko-KR', {
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            if (confirm(`${workingDateString}의 출결을 모두 초기화하시겠습니까?`)) {
                todayAttendance = {};
                
                // 모든 학생을 정상으로 초기화
                for (let i = 1; i <= 35; i++) {
                    const card = document.getElementById(`student-${i}`);
                    const statusDiv = document.getElementById(`status-${i}`);
                    
                    card.classList.remove('absent', 'late', 'early-leave');
                    statusDiv.textContent = '';
                }
                
                updateTodayStats();
                saveWorkingDateData();
                
                // 달력이 작업 날짜를 보여주고 있다면 업데이트
                if (selectedDate.toDateString() === workingDate.toDateString()) {
                    updateSelectedDateRecords();
                }
                
                createCalendar();
                showMessage('출결이 초기화되었습니다.');
            }
        }
        
        // 모든 데이터 초기화
        function resetAllData() {
            if (confirm('⚠️ 경고: 모든 날짜의 출결 기록이 완전히 삭제됩니다.\n\n정말로 모든 데이터를 초기화하시겠습니까?')) {
                if (confirm('한번 더 확인합니다. 정말로 모든 출결 기록을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                    // 모든 데이터 초기화
                    todayAttendance = {};
                    allRecords = {};
                    
                    // 로컬 스토리지 모든 출결 데이터 삭제
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('attendance_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // 현재 화면 초기화
                    for (let i = 1; i <= 35; i++) {
                        const card = document.getElementById(`student-${i}`);
                        const statusDiv = document.getElementById(`status-${i}`);
                        
                        card.classList.remove('absent', 'late', 'early-leave');
                        statusDiv.textContent = '';
                    }
                    
                    updateTodayStats();
                    createCalendar();
                    
                    alert('✅ 모든 출결 기록이 삭제되었습니다.');
                }
            }
        }
        
        // 로컬 스토리지에서 오늘 데이터 복원
        function restoreTodayData() {
            const today = new Date().toLocaleDateString('ko-KR');
            const todayData = localStorage.getItem(`attendance_${today}`);
            
            if (todayData) {
                todayAttendance = JSON.parse(todayData);
                
                // 화면에 반영
                Object.keys(todayAttendance).forEach(studentNumber => {
                    const record = todayAttendance[studentNumber];
                    const card = document.getElementById(`student-${studentNumber}`);
                    const statusDiv = document.getElementById(`status-${studentNumber}`);
                    
                    if (card && statusDiv) {
                        card.classList.remove('absent', 'late', 'early-leave');
                        card.classList.add(record.status);
                        statusDiv.textContent = `${getStatusKorean(record.status)} (${record.time})`;
                    }
                });
                
                updateTodayStats();
            }
        }
        
        // 페이지 로드시 초기화
        window.onload = function() {
            // 작업 날짜 초기화 (오늘이 주말이면 평일로 조정)
            const today = new Date();
            if (today.getDay() === 0) { // 일요일
                workingDate.setDate(today.getDate() + 1); // 월요일로
            } else if (today.getDay() === 6) { // 토요일
                workingDate.setDate(today.getDate() + 2); // 월요일로
            }
            
            // 모든 날짜 변수를 동기화
            currentDate = new Date(workingDate);
            selectedDate = new Date(workingDate);
            
            displayWorkingDate();
            createStudentCards();
            loadFromLocalStorage();
            loadWorkingDateData();
            createCalendar();
        };
        
        // 모달 외부 클릭시 닫기
        window.onclick = function(event) {
            const historyModal = document.getElementById('historyModal');
            const periodModal = document.getElementById('periodModal');
            
            if (event.target === historyModal) {
                historyModal.style.display = 'none';
            }
            
            if (event.target === periodModal) {
                closePeriodModal();
            }
        };
    </script>
</body>
</html>
